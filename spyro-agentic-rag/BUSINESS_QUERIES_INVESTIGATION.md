# Business Queries Investigation Report

**Date**: August 2, 2025  
**Purpose**: Comprehensive investigation of all 60 business queries to identify root causes of failures  
**Method**: Run each query via curl, examine response quality, verify Neo4j data, analyze Cypher queries used  

## Investigation Results

### Query 1: What percentage of our ARR is dependent on customers with success scores below 70?
**Status**: ❌ FAILED  
**Expected**: 20.6% (verified via direct Neo4j query)  
**Actual Response**: "It seems there are no customers with success scores below 70 in our database. Therefore, none of our Annual Recurring Revenue (ARR) is dependent on customers with success scores below 70."  

**Investigation**:
- ✅ Verified customer success scores exist in Neo4j:
  - 6 customers have scores < 70: StartupXYZ (45), RetailPlus (58), EduTech (35), LogiCorp (68), DataSync (52), HealthTech Solutions (41)
- ✅ Verified revenue/subscription data exists:
  - Low score customers total: $14.8M
  - Total ARR: $71.8M
  - Actual percentage: 20.6%
- ❌ Agent failed to find this data despite it being present

**Root Cause Analysis**:
- When tested directly, the agent WORKS CORRECTLY and returns 20.61%
- Agent invoked GraphQuery with proper Cypher: `MATCH (c:Customer) WHERE c.success_score < 70`
- The Text2CypherRetriever correctly generated LlamaIndex-compatible Cypher from the examples
- **EVIDENCE**: The API instance was likely using stale code or cached state
- **CONCLUSION**: The API needs to be restarted after code changes to pick up the fixed cypher examples

---

### Query 2: Which customers are at high risk due to low product adoption?
**Status**: ❌ FAILED  
**Expected**: List of customers with specific low adoption metrics  
**Actual Response**: Generic list of 10 customers without any adoption metrics or risk justification  

**Investigation**:
- ✅ Verified adoption data exists:
  - Feature adoption rates: 25-85% across features
  - Customer usage growth: 39-85% for various customers
  - No direct customer-level adoption rates found
- ❌ Agent response lacks specificity - just lists customers without metrics
- ❌ No risk calculation or threshold applied

**Root Cause**: The response appears to be generic/hallucinated. Agent didn't query for actual adoption metrics or apply any risk threshold. The data model may lack direct customer adoption rates (only feature adoption and usage growth exist).

---

### Query 3: What is the impact on revenue if we lose our top 3 enterprise customers?
**Status**: ✅ SUCCESS  
**Expected**: $24.5M revenue impact  
**Actual Response**: Correctly identified GlobalRetail ($9M), TechCorp ($8M), AutoDrive ($7.5M) = $24.5M total  

**Investigation**:
- ✅ Response matches verified Neo4j data exactly
- ✅ Agent correctly identified enterprise customers
- ✅ Proper revenue calculation performed

**Root Cause**: N/A - Query succeeded

### Query 4: How many customers have success scores below 60, and what is their combined ARR?
**Status**: ✅ SUCCESS  
**Expected**: 5 customers, $10.8M combined ARR  
**Actual Response**: "There are 5 customers with success scores below 60, and their combined ARR is $10.8 million."  

**Investigation**:
- ✅ Response matches verified Neo4j data exactly
- ✅ Customers: EduTech (35), HealthTech Solutions (41), StartupXYZ (45), DataSync (52), RetailPlus (58)
- ✅ Combined ARR: $1.5M + $1.8M + $2M + $2.5M + $3M = $10.8M

**Cypher Query Used** (from debug script):
```cypher
MATCH (c) WHERE ('__Entity__' IN labels(c) AND 'CUSTOMER' IN labels(c))
OPTIONAL MATCH (c)-[:HAS_SUCCESS_SCORE]->(s)
OPTIONAL MATCH (c)-[:SUBSCRIBES_TO]->(sub)
WITH c, coalesce(s.score, s.value, 100) as success_score,
CASE 
    WHEN sub.value CONTAINS '$' AND sub.value CONTAINS 'M' THEN toFloat(replace(replace(sub.value, '$', ''), 'M', '')) * 1000000
    WHEN sub.value CONTAINS '$' THEN toFloat(replace(sub.value, '$', ''))
    ELSE coalesce(toFloat(sub.value), 0)
END as subscription_value
WHERE success_score < 60
RETURN count(c) as customer_count, sum(subscription_value) as combined_arr
```

**Root Cause**: N/A - Query succeeded. The Text2CypherRetriever correctly used the enhanced examples.

---

### Query 5: What percentage of customers experienced negative events in the last 90 days?
**Status**: ❌ FAILED  
**Expected**: Percentage based on actual event data  
**Actual Response**: "100% of customers experienced negative events in the last 90 days."  

**Investigation**:
- ✅ Verified EVENT nodes exist (22 total)
- ❌ Events have NO DATE values (all null)
- ❌ Only 2 customer-event relationships exist (not 46 as agent claimed)
- ❌ No events can be filtered by date since dates are missing

**Cypher Query Generated by Agent**:
```cypher
MATCH (c:Customer)-[r:EXPERIENCED]->(e:Event) 
WHERE e.date >= date() - duration('P90D') AND e.type = 'Negative' 
RETURN count(DISTINCT c) AS negative_customers, 
       (MATCH (c:Customer) RETURN count(c)) AS total_customers
```

**Root Cause**: 
1. The agent generated an incorrect query that returns all customers (46) as both negative_customers and total_customers
2. The data model lacks proper event dates, making time-based queries impossible
3. Very few customer-event relationships exist (only 2 out of 46 customers)

---

### Query 6: Which customers are at highest risk of churn based on success scores and recent events?
**Status**: ⚠️ PARTIAL SUCCESS  
**Expected**: Customers with low scores AND churn risks or negative events  
**Actual Response**: Listed EduTech (35), HealthTech Solutions (41), StartupXYZ (45) based on low scores only  

**Investigation**:
- ✅ Correctly identified lowest success score customers
- ⚠️ Missed that EduTech has an actual "churn" risk in the data
- ❌ Didn't check for actual risk relationships
- ❌ Events data is incomplete (no dates)

**Tool Used**: UnifiedSearch (not GraphQuery)

**Root Cause**: 
- Agent used UnifiedSearch instead of GraphQuery, which limited its ability to find risk relationships
- Response is based only on success scores, not comprehensive risk analysis
- The query would benefit from a specific Cypher example combining scores and risks

---

### Query 7: What are the projected quarterly revenue trends for the next fiscal year?
**Status**: ❌ FAILED  
**Expected**: Quarterly revenue projections based on current subscriptions and renewal probabilities  
**Actual Response**: "It seems that the subscription values for the customers are not directly available in the current dataset. To project quarterly revenue trends, we would typically need detailed subscription values and renewal patterns."  

**Investigation**:
- ✅ Verified subscription data exists with values and renewal probabilities
- ✅ Found profitability nodes with revenue data ($42M, $17.3M, $12.5M annually)
- ❌ Agent failed to find subscription values despite them being present
- ❌ No actual quarterly projections exist in the data

**Agent's Cypher Query**:
```cypher
MATCH (c:Customer)-[:SUBSCRIBES_TO]->(p:Product) 
RETURN c.name, p.name, c.subscription_value
```

**Root Cause**: 
1. Agent generated incorrect Cypher - subscription_value is on SUBSCRIPTION nodes, not CUSTOMER nodes
2. The data model lacks actual quarterly projections - only has current subscription values and renewal probabilities
3. Agent would need to calculate projections from existing data rather than retrieve pre-calculated projections

---

### Query 8: Which teams have the highest operational costs relative to their output?
**Status**: ⚠️ PARTIAL SUCCESS  
**Expected**: Teams ranked by cost/output ratio  
**Actual Response**: "The team with the highest operational costs relative to their output is the Security Team, with an operational cost of $1,800,000. However, the output data for this team is not available, which makes it difficult to calculate the exact ratio of cost to output."  

**Investigation**:
- ✅ Found operational_cost property only on Security Team ($1.8M)
- ✅ Teams have efficiency_ratio and revenue_supported properties that could measure output
- ❌ Agent used incorrect property name "output" which doesn't exist
- ❌ Agent had to retry query due to outdated EXISTS syntax

**Agent's Cypher Queries**:
1. Failed: `MATCH (t:Team) WHERE EXISTS(t.operational_cost)...` (outdated syntax)
2. Fixed: `MATCH (t:Team) WHERE t.operational_cost IS NOT NULL RETURN t.name AS team, t.operational_cost AS cost, t.output AS output...`

**Root Cause**: 
1. Only Security Team has operational_cost property; other teams use monthly_cost
2. Agent incorrectly assumed "output" property exists instead of using efficiency_ratio or revenue_supported
3. Limited data makes proper cost/output analysis impossible

---

### Query 9: How many active risks are unmitigated, and what is their potential financial impact?
**Status**: ❌ FAILED  
**Expected**: 10 active risks with $20.4M total impact  
**Actual Response**: "There are currently no active unmitigated risks, and therefore, the potential financial impact is $0."  

**Investigation**:
- ✅ Verified 10 active risks exist with $20.4M total impact_amount
- ❌ Agent searched for status='Unmitigated' instead of 'active'
- ❌ Agent searched for potential_impact instead of impact_amount
- ✅ Data exists: StartupXYZ ($2M), EduTech ($1.5M), DataSync ($1.25M), etc.

**Agent's Cypher Query**:
```cypher
MATCH (r:Risk {status: 'Unmitigated'}) 
RETURN count(r) as unmitigated_risks, sum(r.potential_impact) as total_financial_impact
```

**Root Cause**: 
1. Agent used wrong status value ('Unmitigated' vs 'active')
2. Agent used wrong property name (potential_impact vs impact_amount)
3. Cypher examples likely don't cover risk queries with correct property names

---

### Query 10: What is the customer retention rate across different product lines?
**Status**: ❌ FAILED  
**Expected**: Retention rates calculated from subscription data or renewal probabilities  
**Actual Response**: All products show 0% retention - "It appears that currently, there are no retained customers across any of the product lines."  

**Investigation**:
- ✅ Found USES relationships: SpyroCloud (8), SpyroAI (5), SpyroSecure (4)
- ✅ Found avg success scores: SpyroCloud (68.1), SpyroAI (62.4), SpyroSecure (82.7)
- ✅ Found SUBSCRIBES_TO relationships (17 total)
- ❌ Agent looked for r.retained property on USES relationship - doesn't exist
- ❌ No direct retention data; would need to calculate from subscriptions/renewals

**Agent's Cypher Query**:
```cypher
MATCH (c:Customer)-[r:USES]->(p:Product) 
RETURN p.name AS product, 
       COUNT(DISTINCT c) AS customer_count, 
       SUM(CASE WHEN r.retained = true THEN 1 ELSE 0 END) AS retained_count
```

**Root Cause**: 
1. Agent assumed a "retained" property exists on the USES relationship
2. Retention must be calculated from subscription status or renewal probability
3. The data model lacks explicit retention tracking

---

### Query 11: Which product features have the highest usage but lowest satisfaction scores?
**Status**: ❌ FAILED  
**Expected**: Features ranked by high usage/low satisfaction  
**Actual Response**: Generic response about data challenges - "It seems there is a challenge in retrieving specific data..."  

**Investigation**:
- ✅ Found features with adoption_rate: Enhanced Security Module (85.5%), Zero-trust (72.3%), etc.
- ✅ Found separate SATISFACTION_SCORE nodes (33 total)
- ❌ Agent looked for non-existent HAS_USAGE and HAS_SATISFACTION relationships
- ❌ No direct link between features and satisfaction scores in data model
- ❌ Agent failed with syntax errors (EXISTS) and gave up

**Agent's Cypher Queries**:
1. `MATCH (f:Feature)-[:HAS_USAGE]->(u:Usage), (f)-[:HAS_SATISFACTION]->(s:Satisfaction)...` (failed - relationships don't exist)
2. Attempted with EXISTS syntax (failed - outdated)
3. Gave up and returned generic response

**Root Cause**: 
1. Data model has features with adoption_rate but satisfaction scores are separate entities
2. No relationships linking features to satisfaction scores
3. Agent couldn't adapt to actual data structure

---

### Query 12: What is the average time to resolve critical customer issues by product?
**Status**: ❌ FAILED  
**Expected**: Resolution times by product for critical issues  
**Actual Response**: Generic response - "It seems there is no specific data available..."  

**Investigation**:
- ✅ Found ISSUE nodes (26) and CONCERN nodes (5)
- ✅ Found support_escalation events (2)
- ❌ Agent looked for non-existent HAS_ISSUE relationship
- ❌ Agent assumed Issue label (actual: ISSUE) and time_to_resolve property
- ❌ CONCERN nodes have no severity property
- ❌ No resolution time data in the model

**Agent's Cypher Queries**:
1. `MATCH (c:Customer)-[r:HAS_ISSUE]->(i:Issue {severity: 'Critical'})...` (failed - wrong label, relationship)
2. Attempted with HAS_CONCERN relationship (failed - no resolution dates)
3. Gave up and used UnifiedSearch

**Root Cause**: 
1. Data model lacks issue resolution tracking
2. Agent used wrong entity names (Issue vs ISSUE)
3. No time-to-resolve metrics in the data

---

[Template for remaining 48 queries...]

## Summary Statistics
- **Total Queries Tested**: 12
- **Successful**: 2 (Q3, Q4)
- **Failed**: 8 (Q1 via API, Q2, Q5, Q7, Q9, Q10, Q11, Q12)
- **Partial Success**: 2 (Q6, Q8)
- **Pending**: 48
- **Current Success Rate**: 16.7% (2/12)

## Common Failure Patterns

Based on the first 12 queries, clear patterns emerge:

### 1. **Property Name Mismatches** (7/12 queries affected)
- Agent assumes properties that don't exist: `subscription_value`, `retained`, `potential_impact`, `output`
- Agent uses wrong property names: `potential_impact` vs `impact_amount`
- Agent doesn't know actual property names on entities

### 2. **Relationship Mismatches** (4/12 queries affected)
- Agent invents relationships: `HAS_USAGE`, `HAS_SATISFACTION`, `HAS_ISSUE`
- Agent doesn't know actual relationship names in the data

### 3. **Entity Label Mismatches** (3/12 queries affected)
- Agent uses wrong case: `Issue` vs `ISSUE`
- Agent uses wrong status values: `Unmitigated` vs `active`

### 4. **Missing Data Model Knowledge** (8/12 queries affected)
- Agent doesn't understand data is spread across disconnected entities
- Features have adoption_rate but satisfaction is in separate nodes
- Subscriptions are separate from customers, not properties on them

### 5. **Calculation vs Retrieval** (5/12 queries affected)
- Agent tries to retrieve pre-calculated values that don't exist
- Should calculate projections, retention rates, etc. from raw data

### 6. **Outdated Cypher Syntax** (2/12 queries affected)
- Agent uses deprecated `EXISTS(property)` syntax
- Should use `property IS NOT NULL`

### 7. **Generic Fallback Responses** (6/12 queries affected)
- When queries fail, agent gives generic non-specific answers
- Doesn't attempt to explore alternative data paths

## Root Cause Analysis

The Text2CypherRetriever is generating queries based on assumptions about the data model rather than actual knowledge. The cypher examples in `cypher_examples_enhanced_v2.py` don't cover enough real-world scenarios with the actual property names, relationships, and data structures.

## Recommendations
[To be provided after completing investigation]

## Recommendations
[To be provided after investigation]